define(["jquery","core/config","theme_ufsm2/select2","theme_ufsm2/bootstrap"],function(a,b,c){function d(){URL=b.wwwroot+"/message/mobile.php",a(window).width()<986?(window.location.pathname.match("/message/index.php")&&(window.location.pathname=window.location.pathname.replace("index","mobile")),/\/$/.test(window.location.pathname),3==e("m")&&a("body").animate({scrollTop:a("body").height()},100),a(".panel-collapse:not(:first)").collapse("hide"),a(document).find("[data-block]").addClass("hidden"),a("#menu-messages>a").removeAttr("data-toggle"),a("#menu-messages>a").attr("href",URL+"?m=1"),a("#menu-notification>a").removeAttr("data-toggle"),a("#menu-notification>a").attr("href",URL+"?m=2")):("/message/mobile.php"==window.location.pathname&&(window.location.pathname="/message/index.php"),a("#menu-messages>a").attr("data-toggle","dropdown"),a("#menu-messages>a").attr("href","#"),a("#menu-notification>a").attr("data-toggle","dropdown"),a("#menu-notification>a").attr("href","#"))}function e(a){var b=window.location.search.match(new RegExp("(\\?|&)"+a+"(\\[\\])?=([^&]*)"));return b?b[3]:!1}return a.getScript("//www.google-analytics.com/analytics.js").done(function(){gaExec()}),{init:function(c){function e(){a.post(q,{url:urlAtual}).done(function(a){var b={msg:"",dtEnvio:0};if(a.msgLast.length)for(var c in a.msgLast)o.prepend(h(a.msgLast[c]));else b.msg="Parabéns! <br> Você leu todas as mensagens da sua caixa de entrada.",o.prepend(h(b));if(a.notifLast.length)for(var c in a.notifLast)p.prepend(i(a.notifLast[c]));else b.msg="Parabéns! <br> Você leu todas as notificações da sua caixa de entrada.",p.prepend(i(b))})}function f(){setTimeout(function(){g(),f()},12e4)}function g(){var b={msg:""};a.post(q,{op:"exists",url:urlAtual}).done(function(c){c.msgExist?(a(".msg-null").remove(),a("#menu-messages>a sup").length>0?a("#menu-messages>a sup").html(c.msgExist):a("#menu-messages>a").append("<sup>"+c.msgExist+"</sup>"),k(c.msgExist),a(".icon-message").addClass("icon-help")):(a(".icon-message").removeClass("icon-help"),o.children().remove(),b.msg="Parabéns! <br> Você leu todas as mensagens da sua caixa de entrada.",o.prepend(h(b)),a("#menu-messages>a sup").remove()),c.notifExist?(a(".notif-null").remove(),a("#menu-notification>a sup").length>0?a("#menu-notification>a sup").html(c.notifExist):a("#menu-notification>a").append("<sup>"+c.notifExist+"</sup>"),l(c.notifExist)):(p.children().remove(),b.msg="Parabéns! <br> Você leu todas as notificações da sua caixa de entrada.",p.prepend(i(b)),a("#menu-notification>a sup").remove())})}function h(a){var b="";return a.dtEnvio>0?(a.dtEnvio=new Date(1e3*a.dtEnvio),b+='<a class="content ord msg-'+a.id+" "+a.classe+'" data-t="'+a.dtEnvio.getTime()+'" href="'+a.url+' ">',b+='<div class="notification-img">',b+='<img class="userpicture" src="'+a.foto+'">',b+="</div>",b+='<div class="notification-item">',b+='<h4 class="item-title">'+a.nome+"</h4>",b+='<p class="item-info">'+a.msg,b+="<br><small>"+j(a.dtEnvio.getDate(),2)+"/"+j(a.dtEnvio.getMonth()+1,2)+"/"+a.dtEnvio.getFullYear()+" "+j(a.dtEnvio.getHours(),2)+":"+j(a.dtEnvio.getMinutes(),2),b+="</div>",b+="</a>"):(b+='<a class="content ord msg-null" href="#">',b+='<div class="notification-img"></div>',b+='<div class="notification-item">',b+='<h4 class="item-title"></h4>',b+='<p class="item-info">'+a.msg,b+="</div>",b+="</a>"),b}function i(a){var b="";return a.dtEnvio>0?(a.dtEnvio=new Date(1e3*a.dtEnvio),b+='<a class="content ord notif-'+a.dtEnvio.getTime()+" "+a.classe+'" data-t="'+a.dtEnvio.getTime()+'" href="'+a.url+' ">',b+='<div class="notification-img">',b+='<img class="userpicture" src="'+a.foto+'">',b+="</div>",b+='<div class="notification-item">',b+='<p class="item-info">'+a.msg,b+="<br><small>",b+=j(a.dtEnvio.getDate(),2)+"/",b+=j(a.dtEnvio.getMonth()+1,2)+"/",b+=a.dtEnvio.getFullYear()+" ",b+=j(a.dtEnvio.getHours(),2)+":",b+=j(a.dtEnvio.getMinutes(),2)+"</small></p>",b+="</div>",b+="</a>"):(b+='<a class="content ord notif-null" href="#">',b+='<div class="notification-img"></div>',b+='<div class="notification-item">',b+='<p class="item-info">'+a.msg+"</p>",b+="</div>",b+="</a>"),b}function j(a,b){for(var c=0;c<b-String(a).length;c++)a="0"+a;return a}function k(b){a.post(q,{op:"msg-new",msg:b}).done(function(b){for(var c in b){if(a("#msg-list > .msg-"+b[c].id).length){var d=new Date(b[c].dtEnvio.date);a(".msg-"+b[c].id).data("t")!=d.getTime()&&(a("#msg-list > .msg-"+b[c].id).remove(),o.prepend(h(b[c])))}else o.prepend(h(b[c]));m(a("#msg-list"))}})}function l(b){a.post(q,{op:"notif-new",msg:b,url:urlAtual}).done(function(b){for(var c in b){var d=new Date(1e3*b[c].dtEnvio);a(".notif-"+d.getTime()).length||p.prepend(i(b[c])),m(a("#notif-list"))}})}function m(a){a.find(".ord").sort(function(a,b){return+b.dataset.t-+a.dataset.t}).appendTo(a)}function n(){hwindow=a(window).innerHeight(),hfooter=a("footer").outerHeight(!0),hheader=a(".navbar.navbar-inverse.navbar-fixed-top").outerHeight(!0),hinput=a(".messagesend").outerHeight(!0),finalHeight=hwindow-hfooter-hheader-hinput-40,a(".messagehistory>.messagehistory").height(finalHeight),a(".messagehistory>.messagehistory").animate({scrollTop:hmessage},100)}window.$=a,urlAtual=window.location.href;var o=(a("#menu-messages"),a("#msg-list")),p=(a("#menu-notification"),a("#notif-list")),q=b.wwwroot+"/theme/ufsm2/ajax/notification.ajax.php?sesskey="+b.sesskey;a(".input-select2").select2({width:"100%",dropdownAutoWidth:!0,tags:"true"}),a(".closeall").click(function(){a(".panel-collapse.in:not(:first)").collapse("hide")}),a(".openall").click(function(){a('.panel-collapse:not(".in")').collapse("show")}),a(".readAllNotif").click(function(){a.post(q,{op:"notif-read"}),setTimeout(function(){g()},1e3)}),a(".readAllMsg").click(function(){a.post(q,{op:"msg-read"}),setTimeout(function(){g()},1e3)}),e(),f(),d(),setTimeout(function(){g()},1e3),hmessage=a(".messagehistory>.messagehistory").height(),a(window).resize(function(){n()}),n()}}});